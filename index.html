<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Admission Tools & Luiss Prep</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéì</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #F5F5F7;
            --card-bg: #FFFFFF;
            --primary: #0071E3;
            --text-main: #1D1D1F;
            --text-sec: #86868B;
            --text-light: #C7C7CC;
            --border-light: #D2D2D7;
            --input-bg: #F5F5F7;
            --radius-xl: 24px;
            --radius-m: 14px;
            --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.04);
            
            /* Status Colors */
            --success: #34C759;
            --success-bg: #E8FCE8;
            --warning: #FF9F0A;
            --warning-bg: #FFF5E5;
            --danger: #FF3B30;
            --danger-bg: #FFF0F0;
            --whatsapp: #25D366;
            --whatsapp-bg: #E7FCEB;
            
            /* Luiss Colors */
            --luiss-blue: #00338D; 
            --luiss-light: #Eef4ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            position: relative;
            padding-bottom: 40px;
        }

        /* --- VIEWS --- */
        .view-section {
            display: none;
            width: 100%;
            will-change: opacity, transform;
        }
        .view-section.active {
            display: block;
            animation: fadeIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }
        
        @keyframes fadeIn { from{opacity:0; transform: translateY(8px);} to{opacity:1; transform: translateY(0);} }

        /* --- CARDS & MENU --- */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: var(--shadow-card);
            margin-bottom: 20px;
            border: 1px solid rgba(0,0,0,0.02);
            position: relative;
            z-index: 10;
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--radius-xl);
            margin-bottom: 16px;
            cursor: pointer;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(0,0,0,0.02);
            user-select: none;
            position: relative;
            z-index: 20;
            transform: scale(1);
            transition: transform 0.1s ease-out, background 0.2s;
            text-decoration: none; /* Per i link avvolti */
        }
        .menu-item:active { transform: scale(0.98); background: #f9f9f9; }

        .menu-icon {
            font-size: 22px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
            font-weight: 700;
        }

        .menu-content h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-main);
        }
        .menu-content p {
            margin: 0;
            font-size: 13px;
            color: var(--text-sec);
            line-height: 1.4;
        }

        /* --- HEADER --- */
        .nav-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            padding: 0 4px;
        }
        .back-btn {
            background: #E5E5EA;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-main);
            cursor: pointer;
            margin-right: 16px;
            transition: transform 0.1s;
        }
        .back-btn:active { transform: scale(0.9); }
        
        .page-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        /* --- INPUTS --- */
        .input-group { margin-bottom: 20px; }
        label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-sec);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-left: 4px;
        }
        .input-box {
            width: 100%;
            height: 52px;
            padding: 0 16px;
            font-size: 16px;
            font-family: inherit;
            font-weight: 500;
            background: var(--input-bg);
            border: none;
            border-radius: 14px;
            color: var(--text-main);
            outline: none;
            transition: box-shadow 0.2s;
        }
        .input-box:focus {
            box-shadow: 0 0 0 2px var(--primary) inset;
            background: #fff;
        }

        /* --- PREDICTOR STYLES --- */
        .result-container {
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid #E5E5EA;
            display: none;
        }
        .result-badge {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: block;
        }
        .result-main {
            font-size: 22px;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 8px;
            color: var(--text-main);
        }
        .result-sub {
            font-size: 15px;
            color: var(--text-sec);
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .data-match-box {
            background: #F2F2F7;
            border-radius: 12px;
            padding: 16px;
            margin-top: 20px;
            display: none;
        }
        .match-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 6px;
            text-transform: uppercase;
        }
        .tag-ok { background: #D1FAE5; color: #065F46; }
        .tag-ko { background: #FEE2E2; color: #991B1B; }

        /* --- QUIZ STYLES --- */
        .luiss-header {
            background: var(--luiss-light);
            border-radius: 16px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--luiss-blue);
            box-shadow: inset 0 0 0 1px rgba(0, 51, 141, 0.08);
        }
        .abort-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            color: var(--text-sec);
            cursor: pointer;
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .abort-btn:active { background: rgba(0,0,0,0.05); color: var(--danger); }

        .timer-badge {
            font-variant-numeric: tabular-nums;
            font-weight: 700;
            font-size: 15px;
            background: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            color: var(--luiss-blue);
        }
        
        .reading-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-main);
            background: var(--input-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border-left: 4px solid var(--luiss-blue);
            max-height: 200px;
            overflow-y: auto;
        }

        .question-text {
            font-size: 18px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 24px;
            color: var(--text-main);
        }

        .quiz-opt-btn {
            background: var(--input-bg);
            padding: 18px;
            border-radius: 16px;
            margin-bottom: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            border: 2px solid transparent;
        }
        .quiz-opt-btn:active { transform: scale(0.98); }
        .quiz-opt-btn.selected { 
            border-color: var(--luiss-blue); 
            background: #fff; 
            box-shadow: 0 4px 12px rgba(0,51,141,0.1); 
        }
        
        .quiz-marker {
            min-width: 24px; height: 24px;
            border-radius: 50%;
            background: #fff;
            color: var(--text-sec);
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: 700;
            margin-right: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            margin-top: 0px;
            transition: background 0.2s;
        }
        .quiz-opt-btn.selected .quiz-marker { background: var(--luiss-blue); color: #fff; }

        .nav-actions { display: flex; gap: 10px; margin-top: 30px; }
        .action-btn { 
            flex: 1; 
            height: 52px; 
            border-radius: 14px; 
            border: none; 
            font-weight: 600; 
            font-size: 15px; 
            cursor: pointer; 
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn-primary { background: var(--luiss-blue); color: #fff; box-shadow: 0 4px 12px rgba(0, 51, 141, 0.2); }
        .btn-primary:active { opacity: 0.9; transform: scale(0.98); }
        
        .btn-sec { 
            background: #fff; 
            color: var(--text-main); 
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 6px rgba(0,0,0,0.03);
        }
        .btn-sec:active { background: #f5f5f7; transform: scale(0.98); }

        .btn-skip { background: transparent; border: 1px solid transparent; color: var(--text-sec); font-weight: 500;}
        .btn-skip:active { color: var(--text-main); }
        
        .btn-icon { flex: 0 0 52px; font-size: 20px; }

        /* --- STATS GRID --- */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin: 24px 0;
        }
        .stat-box {
            background: var(--input-bg);
            border-radius: 16px;
            padding: 16px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .stat-val { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .stat-lbl { font-size: 10px; text-transform: uppercase; color: var(--text-sec); font-weight: 600; }

        /* --- REVIEW MODE --- */
        .review-item {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
            padding-left: 14px;
        }
        .review-item::before {
            content: ''; position: absolute; left: 0; top: 6px; bottom: 24px; width: 4px; border-radius: 2px; background: var(--border-light);
        }
        .review-item.status-correct::before { background: var(--success); }
        .review-item.status-wrong::before { background: var(--danger); }
        .review-item.status-skipped::before { background: var(--warning); }
        .review-q { font-weight: 600; font-size: 16px; margin-bottom: 12px; color: var(--text-main); line-height: 1.5; }
        .review-opt { font-size: 14px; padding: 10px 14px; border-radius: 10px; margin-bottom: 6px; display: flex; align-items: center; color: var(--text-sec); background: #fff; border: 1px solid rgba(0,0,0,0.05); }
        .review-opt.is-correct { background-color: var(--success-bg); color: #065F46; border-color: rgba(52, 199, 89, 0.2); font-weight: 600; }
        .review-opt.is-wrong { background-color: var(--danger-bg); color: #991B1B; border-color: rgba(255, 59, 48, 0.2); text-decoration: line-through; }

        /* --- FOOTER --- */
        .footer-info {
            margin-top: 40px;
            text-align: center;
            padding-bottom: 20px;
        }
        .footer-text {
            font-size: 12px;
            color: var(--text-sec);
            margin-bottom: 6px;
            line-height: 1.4;
        }
        .footer-link {
            font-size: 13px; /* Leggermente pi√π grande */
            color: var(--text-sec); /* Stesso grigio del disclaimer */
            font-weight: 600;
            text-decoration: none;
            display: block;
            margin-top: 12px;
            transition: color 0.2s;
        }
        .footer-link:hover { color: var(--text-main); }
    </style>
</head>
<body>

    <div class="app-container">

        <section id="view-home" class="view-section active">
            <div style="height: 20px;"></div> 
            
            <div class="menu-item" onclick="window.open('https://chat.whatsapp.com/BTgwlltgG20DlTnDXnroWC?mode=gi_t', '_blank')">
                <div class="menu-icon" style="color: var(--whatsapp); background: var(--whatsapp-bg);">üí¨</div>
                <div class="menu-content">
                    <h3>Gruppo Whatsapp Luiss</h3>
                    <p>Entra nella community candidati</p>
                </div>
            </div>

            <div class="menu-item" onclick="goTo('view-predictor')">
                <div class="menu-icon" style="color: #34C759; background: #E8FCE8;">üçÄ</div>
                <div class="menu-content">
                    <h3>Probabilit√† Ammissione Bocconi*</h3>
                    <p>Analisi dati Early Session 2025</p>
                </div>
            </div>
            
            <div class="menu-item" onclick="goTo('view-luiss-menu')">
                <div class="menu-icon" style="color: var(--luiss-blue); background: var(--luiss-light);">üéì</div>
                <div class="menu-content">
                    <h3>Prep Luiss</h3>
                    <p>100 Esercizi Luiss</p>
                </div>
            </div>

            <div class="footer-info">
                <div class="footer-text">Dati aggiornati alla sessione Early 2025.</div>
                <div class="footer-text">Strumento statistico non ufficiale.</div>
                <a href="https://instagram.com/drissyakisoba" target="_blank" class="footer-link">ig: drissyakisoba</a>
            </div>
        </section>

        <section id="view-predictor" class="view-section">
            <div class="nav-header">
                <button class="back-btn" onclick="goTo('view-home')">‚Üê</button>
                <span class="page-title">Previsione</span>
            </div>

            <div class="card">
                <div class="input-group">
                    <label>Corso</label>
                    <select id="pred-course" class="input-box" onchange="calcPred()">
                        <option value="" disabled selected>Seleziona...</option>
                        <option value="CLEAM">CLEAM</option>
                        <option value="BIEM">BIEM</option>
                        <option value="BIEF">BIEF</option>
                        <option value="BEMACS">BEMACS</option>
                        <option value="CLEACC">CLEACC</option>
                        <option value="GLAW">Global Law</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Media Bocconi</label>
                    <input type="number" id="pred-gpa" class="input-box" placeholder="Es. 8.0" min="6" max="10" step="0.01" inputmode="decimal" oninput="calcPred()">
                </div>

                <div class="input-group">
                    <label>Punteggio Test (Opzionale)</label>
                    <input type="number" id="pred-score" class="input-box" placeholder="Es. 36.5 o 1450" inputmode="decimal" oninput="calcPred()">
                </div>

                <div id="result-area" class="result-container">
                    <span class="result-badge" id="res-badge">Analisi</span>
                    <div class="result-main" id="res-title"></div>
                    <div class="result-sub" id="res-desc"></div>

                    <div id="data-match" class="data-match-box">
                        <span class="data-match-label" style="font-size:10px; font-weight:700; color:var(--text-sec); text-transform:uppercase;">Candidato Simile (Early '25)</span>
                        <div class="data-match-val" id="match-text" style="font-size:14px; margin-top:4px;"></div>
                    </div>
                </div>
            </div>
            
            <div class="footer-info">
                <div class="footer-text" style="color: var(--text-main); font-weight: 500;">
                    * Disclaimer Importante
                </div>
                <div class="footer-text" style="max-width: 320px; margin: 0 auto;">
                    Questa stima si basa sui dati della Early Session. √à uno strumento statistico non ufficiale.
                </div>
            </div>
        </section>

        <section id="view-luiss-menu" class="view-section">
            <div class="nav-header">
                <button class="back-btn" onclick="goTo('view-home')">‚Üê</button>
                <span class="page-title" style="color: var(--luiss-blue);">Prep Luiss</span>
            </div>

            <div style="padding: 0 8px 24px 8px;">
                 <p style="margin:0; color:var(--text-sec); font-size:14px; line-height:1.5;">
                    Ogni set contiene 10 domande da svolgere in 15 minuti. Gli esercizi presentano una difficolt√† maggiore per allenare la velocit√† e la gestione dello stress.
                </p>
            </div>

            <div id="sets-container">
                </div>
        </section>

        <section id="view-luiss-quiz" class="view-section">
            <div class="luiss-header">
                <button class="abort-btn" onclick="abortQuiz()">‚úï</button>
                <span id="quiz-progress" style="font-weight:600; font-size:14px;">1 / 10</span>
                <span id="quiz-timer" class="timer-badge">15:00</span>
            </div>

            <div class="card">
                <div id="luiss-reading-text" class="reading-text" style="display:none;"></div>
                
                <div id="luiss-q-text" class="question-text">Caricamento...</div>
                <div id="luiss-options"></div>
                
                <div class="nav-actions">
                    <button id="btn-prev" class="action-btn btn-sec btn-icon" onclick="prevQuestion()">‚Üê</button>
                    <button class="action-btn btn-skip" onclick="skipLuissQuestion()">Salta</button>
                    <button class="action-btn btn-primary" onclick="submitLuissAnswer()">Conferma</button>
                </div>
            </div>
        </section>

        <section id="view-luiss-result" class="view-section">
            <div class="nav-header">
                <button class="back-btn" onclick="goTo('view-luiss-menu')">‚Üê</button>
                <span class="page-title" style="color: var(--luiss-blue);">Risultato</span>
            </div>
            
            <div class="card" style="text-align:center;">
                <div class="result-badge" style="color: var(--text-sec);">Punteggio Totale</div>
                <div class="result-main" id="final-score-title" style="font-size:48px; margin: 10px 0; color:var(--luiss-blue);">0/10</div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-val" id="stat-correct" style="color:var(--success);">0</div>
                        <div class="stat-lbl">Corrette</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="stat-wrong" style="color:var(--danger);">0</div>
                        <div class="stat-lbl">Errate</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="stat-skipped" style="color:var(--warning);">0</div>
                        <div class="stat-lbl">Saltate</div>
                    </div>
                </div>

                <p class="result-sub" id="final-score-msg" style="margin-top:20px; padding: 0 10px;">Messaggio</p>
                
                <div style="display:flex; flex-direction:column; gap:12px; margin-top:32px;">
                    <button class="action-btn btn-sec" onclick="showReview()">Visualizza Correzioni</button>
                    <button class="action-btn btn-primary" onclick="goTo('view-luiss-menu')">Torna al Menu</button>
                </div>
            </div>
        </section>

        <section id="view-luiss-review" class="view-section">
            <div class="nav-header">
                <button class="back-btn" onclick="goTo('view-luiss-result')">‚Üê</button>
                <span class="page-title" style="color: var(--luiss-blue);">Revisione</span>
            </div>
            
            <div class="card" id="review-container" style="padding:24px 0; background:transparent; box-shadow:none; border:none;">
            </div>
             <button class="action-btn btn-sec" style="width:100%; margin-bottom:40px; background:#fff;" onclick="goTo('view-luiss-menu')">Chiudi Revisione</button>
        </section>

    </div>

    <script>
        // --- NAVIGATION MANAGER ---
        let isQuizActive = false;

        function goTo(id) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            const target = document.getElementById(id);
            if(target) {
                target.style.display = 'block';
                requestAnimationFrame(() => { target.classList.add('active'); });
            }
            window.scrollTo(0,0);
        }

        // --- CONVERTER HELPER ---
        const ANCHORS = [{b:17,s:1050},{b:25,s:1240},{b:30,s:1350},{b:35,s:1440},{b:40,s:1510},{b:50,s:1600}];
        function interp(val, inK, outK) {
            if(inK === 's' && val > 1600) val = 1600;
            if(inK === 'b' && val > 50) val = 50;
            for(let i=0; i<ANCHORS.length-1; i++){
                let l=ANCHORS[i], u=ANCHORS[i+1];
                if(val>=l[inK] && val<=u[inK]) return l[outK] + (val-l[inK])/(u[inK]-l[inK])*(u[outK]-l[outK]);
            }
            let last = ANCHORS[ANCHORS.length-1];
            if (val > last[inK]) return last[outK];
            return 0;
        }

        // --- PREDICTOR DATA ---
        const REAL_DB = [
            {c:'CLEAM', g:7.08, s:40.4, r:0}, {c:'CLEAM', g:7.50, s:39.7, r:1},
            {c:'CLEAM', g:7.25, s:39.0, sat:1490, r:1}, {c:'CLEAM', g:7.50, s:35.0, sat:1430, r:1},
            {c:'CLEAM', g:8.00, s:33.0, sat:1400, r:1}, 
            {c:'CLEAM', g:7.33, s:40.6, r:1}, {c:'CLEAM', g:7.80, s:40.0, r:1},
            {c:'CLEAM', g:7.85, s:39.4, r:1}, {c:'CLEAM', g:7.33, s:38.0, r:1},
            {c:'CLEAM', g:7.50, s:36.5, r:1}, {c:'CLEAM', g:8.16, s:35.0, r:1},
            {c:'CLEAM', g:8.40, s:33.1, r:1}, {c:'CLEAM', g:7.50, s:39.7, r:1},
            {c:'CLEAM', g:8.60, s:29.0, r:1}, {c:'CLEAM', g:8.75, s:28.5, r:1},
            {c:'CLEAM', g:7.75, s:40.0, sat:1510, r:1}, 
            {c:'CLEAM', g:8.00, s:30.5, sat:1360, r:0}, {c:'CLEAM', g:7.00, s:40.4, r:0},
            {c:'CLEAM', g:7.60, s:32.0, r:0}, {c:'CLEAM', g:7.25, s:37.6, r:0},
            {c:'BIEM', g:8.10, s:44.2, r:1},
            {c:'BIEM', g:8.33, s:40.7, r:1}, {c:'BIEM', g:8.75, s:38.0, r:1},
            {c:'BIEM', g:8.00, s:33.0, r:1}, {c:'BIEM', g:8.90, s:31.6, r:1},
            {c:'BIEM', g:8.00, s:39.0, sat:1490, r:0}, {c:'BIEM', g:8.00, s:35.0, sat:1430, r:0},
            {c:'BIEM', g:8.00, s:40.0, sat:1510, r:0}, {c:'BIEM', g:8.00, s:44.0, r:0},
            {c:'BIEF', g:9.17, s:36.5, r:1}, {c:'BIEF', g:8.90, s:36.5, r:1},
            {c:'BIEF', g:8.71, s:35.7, r:1}, 
            {c:'BEMACS', g:8.08, s:37.4, r:1}, {c:'BEMACS', g:8.88, s:43.7, r:1},
            {c:'BEMACS', g:8.50, s:47.6, r:1}, {c:'CLEACC', g:8.08, s:30.0, r:1},
            {c:'GLAW', g:7.30, s:37.2, r:1}
        ];

        const SCORE_THRESHOLDS = { "CLEAM": 52.5, "BIEM": 55.0, "BIEF": 60.0, "BEMACS": 56.0, "CLEACC": 47.5, "GLAW": 51.0 };

        function calcPred() {
            const course = document.getElementById('pred-course').value;
            let gpaVal = document.getElementById('pred-gpa').value.replace(',','.');
            let gpa = parseFloat(gpaVal);
            let rawScoreVal = document.getElementById('pred-score').value.replace(',','.');
            let rawScore = parseFloat(rawScoreVal);
            
            const resArea = document.getElementById('result-area');
            const badge = document.getElementById('res-badge');
            const title = document.getElementById('res-title');
            const desc = document.getElementById('res-desc');
            const matchBox = document.getElementById('data-match');
            const matchText = document.getElementById('match-text');

            if (!course || isNaN(gpa) || gpa < 6 || gpa > 10) { resArea.style.display = 'none'; return; }
            resArea.style.display = 'block';

            let pointsGPA = 45 * ((gpa - 6) / 4);
            const THRESHOLD = SCORE_THRESHOLDS[course];
            let effScore = null;
            let searchScore; 

            if(!isNaN(rawScore)) {
                if (rawScore >= 17 && rawScore <= 50) effScore = rawScore;
                else if (rawScore >= 1040 && rawScore <= 1600) effScore = interp(rawScore, 's', 'b');
                searchScore = effScore || 30; 
            }

            if(effScore === null) {
                let pointsNeeded = THRESHOLD - pointsGPA;
                if(pointsNeeded <= 0) {
                    badge.innerText = "Ammissione Probabile"; badge.style.color = "var(--success)";
                    title.innerText = "Media Eccellente";
                    desc.innerText = `Con media ${gpa}, parti da un vantaggio statistico notevole. Anche un test nella media dovrebbe bastare.`;
                    searchScore = 25;
                } else {
                    let targetVote = (pointsNeeded * 33 / 55) + 17;
                    searchScore = targetVote;
                    let minRange = Math.floor(targetVote);
                    let maxRange = Math.ceil(targetVote);
                    let rangeString = (minRange === maxRange) ? `${minRange}` : `${minRange} - ${maxRange}`;
                    
                    if(targetVote > 50) { rangeString = "Impossibile"; } else if (targetVote > 44) { rangeString = "> 45"; }

                    if(targetVote > 50) {
                        badge.innerText = "Matematicamente Difficile"; badge.style.color = "var(--text-sec)";
                        title.innerText = "Media Insufficiente";
                        desc.innerText = `Anche con un test perfetto, la media ${gpa} penalizza troppo il punteggio totale.`;
                    } else if(targetVote > 44) {
                        badge.innerText = "Sfida Estrema"; badge.style.color = "var(--danger)";
                        title.innerText = `Serve Test: ${rangeString}`;
                        desc.innerText = `Serve un punteggio eccezionale per compensare la media.`;
                    } else if(targetVote > 36) {
                        badge.innerText = "Difficile"; badge.style.color = "var(--warning)";
                        title.innerText = `Serve Test: ${rangeString}`;
                        desc.innerText = `Obiettivo alto. Dovrai superare nettamente la media dei candidati.`;
                    } else if(targetVote > 28) {
                        badge.innerText = "Competitivo"; badge.style.color = "var(--primary)";
                        title.innerText = `Serve Test: ${rangeString}`;
                        desc.innerText = `Con un buon test solido in questo range, hai le carte in regola per entrare.`;
                    } else {
                        badge.innerText = "Posizione Forte"; badge.style.color = "var(--success)";
                        title.innerText = `Serve Test: ${rangeString}`;
                        desc.innerText = `Hai un'ottima media. Ti basta un punteggio test standard per l'obiettivo.`;
                    }
                }
            } else {
                let pointsTest = 55 * ((effScore - 17) / 33);
                let totalScore = pointsGPA + pointsTest;
                searchScore = effScore;
                let gap = totalScore - THRESHOLD;
                let rejectionFound = false;
                let minSafeScore = 0;
                let coveredByAdmitted = false;

                REAL_DB.forEach(r => {
                    if (r.c === course && r.r === 0 && r.g >= (gpa - 0.1) && r.s > minSafeScore) { minSafeScore = r.s; rejectionFound = true; }
                    if (r.c === course && r.r === 1 && gpa >= r.g && effScore >= r.s) { coveredByAdmitted = true; }
                });
                
                if (rejectionFound && effScore <= minSafeScore && !coveredByAdmitted) {
                    badge.innerText = "A Rischio (Storico)"; badge.style.color = "var(--danger)";
                    title.innerText = "Punteggio Critico";
                    desc.innerText = "Candidati con profili simili al tuo sono stati rifiutati in passato.";
                } else if (gap >= 2) {
                    badge.innerText = "Probabile"; badge.style.color = "var(--success)";
                    title.innerText = "Posizionamento Solido";
                    desc.innerText = `Il tuo punteggio combinato risulta superiore alla soglia stimata. Buone possibilit√†.`;
                } else if (gap >= 0) {
                    badge.innerText = "Competitivo"; badge.style.color = "var(--warning)";
                    title.innerText = "Sulla Soglia";
                    desc.innerText = "Sei tecnicamente dentro la soglia, ma il margine √® minimo.";
                } else {
                    if (coveredByAdmitted) {
                        badge.innerText = "Competitivo (Storico Favorevole)"; badge.style.color = "var(--warning)";
                        title.innerText = "Sotto Media ma Possibile";
                        desc.innerText = "Punteggio basso, ma in passato casi simili sono stati ammessi.";
                    } else {
                        badge.innerText = "Insufficiente"; badge.style.color = "var(--danger)";
                        title.innerText = "Sotto Target";
                        desc.innerText = `Combinazione inferiore alla soglia statistica necessaria.`;
                    }
                }
            }
            let bestRecord = null;
            let minDist = Infinity;
            REAL_DB.forEach(r => {
                if(r.c === course || (course === 'BEMACS' && r.c === 'BAI')) { 
                    let dG = (r.g - gpa) * 10; 
                    let dS = (r.s - searchScore);
                    let dist = Math.sqrt(dG*dG + dS*dS);
                    if(dist < minDist) { minDist = dist; bestRecord = r; }
                }
            });
            if (bestRecord && minDist < 15) { 
                matchBox.style.display = 'block';
                let tagHtml = bestRecord.r === 1 ? '<span class="match-tag tag-ok">Ammesso</span>' : '<span class="match-tag tag-ko">Non Ammesso</span>';
                let scoreText = bestRecord.sat ? `SAT ${bestRecord.sat}` : `Test ${bestRecord.s.toFixed(1)}`;
                matchText.innerHTML = `Media ${bestRecord.g} + ${scoreText} ${tagHtml}`;
            } else { matchBox.style.display = 'none'; }
        }

        // --- PREP LUISS LOGIC ---
        const SET_NAMES = [
            "Ragionamento Critico-Verbale", "Analisi Matematica & Problemi", "Comprensione del Testo", 
            "Logica Insiemistica & Sillogismi", "Serie Numeriche & Problem Solving", "Deduzioni Logiche Complesse",
            "Geometria Piana & Solida", "Proporzioni & Calcolo", "Esercizi Misti (A)", "Esercizi Misti (B)"
        ];

        // FIXED DATABASE: Undefined removed, Texts corrected.
        const RAW_SETS = [
            [ // SET 1: Verbale
                {t: "Dario crede che 'Solo i laureati in Economia possano fare richiesta per lo stage'. Il bando recita: 'Possono fare richiesta i laureati in Economia, oppure chi ha maturato 3 anni di esperienza nel settore finanziario'. L'informazione:", o: ["Va contro la convinzione di Dario", "Conferma la convinzione di Dario", "Non ha influenza", "√à compatibile"], c: 0},
                {t: "Elena √® convinta che il negozio chiuda alle 19:00. Un cartello dice: 'Apertura continuata dalle 9:00 alle 21:00'. L'informazione:", o: ["Va contro la convinzione di Elena", "Conferma la convinzione", "Non ha influenza", "Specifica solo l'orario mattutino"], c: 0},
                {t: "Si consideri vera l'affermazione: 'Se e solo se piove, prendo l'ombrello'. Oggi non ho preso l'ombrello. Dunque:", o: ["Non piove", "Piove", "Forse piove", "Ho dimenticato l'ombrello"], c: 0},
                {t: "Negare la frase: 'Tutti i candidati hanno superato il test o sono stati ammessi con riserva'.", o: ["Esiste almeno un candidato che non ha superato il test e non √® stato ammesso con riserva", "Nessun candidato ha superato il test", "Tutti i candidati sono stati bocciati", "Qualche candidato ha superato il test ma non √® stato ammesso"], c: 0},
                {t: "Marco crede che il volo parta dal Terminal 1. Il tabellone indica 'Tutti i voli internazionali partono dal Terminal 2'. Il volo di Marco √® per Londra. L'informazione:", o: ["Va contro la convinzione di Marco", "Conferma la convinzione", "Non ha influenza", "√à irrilevante"], c: 0},
                {t: "Condizione necessaria per vincere il concorso √® essere residenti in Italia. Luigi ha vinto il concorso. Dunque:", o: ["Luigi risiede in Italia", "Luigi potrebbe non risiedere in Italia", "Tutti i residenti vincono", "Luigi √® nato in Italia"], c: 0},
                {t: "Condizione sufficiente affinch√© il numero sia pari √® che sia divisibile per 4. Il numero X non √® pari. Dunque:", o: ["X non √® divisibile per 4", "X √® divisibile per 4", "X √® dispari ma divisibile per 4", "Non si pu√≤ concludere"], c: 0},
                {t: "Giulia crede che suo cugino non mangi glutine. Vede il cugino mangiare un piatto di pasta di grano duro. L'evento:", o: ["Smentisce la credenza", "Conferma la credenza", "Non influenza la credenza", "√à un'eccezione"], c: 0},
                {t: "Se √® falso che 'Nessun dipendente parla tedesco', allora:", o: ["Almeno un dipendente parla tedesco", "Tutti i dipendenti parlano tedesco", "Nessun dipendente parla inglese", "Chi parla tedesco √® dipendente"], c: 0},
                {t: "Luca crede che il museo sia chiuso il luned√¨. Il sito web dice 'Aperto tutti i giorni tranne il marted√¨'. L'informazione:", o: ["Va contro la convinzione di Luca", "Conferma la convinzione", "Non ha influenza", "√à ambigua"], c: 0}
            ],
            [ // SET 2: Matematica
                {t: "Un libro pesa 800g. Le pagine costituiscono il 90% del peso. Si sostituisce la copertina con una che pesa la met√† della precedente. Quanto pesa ora il libro?", o: ["760 g", "720 g", "780 g", "750 g"], c: 0}, 
                {t: "Il prezzo di un'azione aumenta del 20% il primo giorno e diminuisce del 20% il secondo. Rispetto al prezzo iniziale, il prezzo finale √®:", o: ["Diminuito del 4%", "Uguale", "Aumentato del 4%", "Diminuito del 10%"], c: 0},
                {t: "In una ricetta, il rapporto Farina:Zucchero √® 3:1 e Zucchero:Burro √® 2:1. Se uso 300g di Burro, quanta Farina serve?", o: ["1800 g", "900 g", "600 g", "1200 g"], c: 0}, 
                {t: "Un triangolo ha base B e altezza H. Se aumento B del 20% e diminuisco H del 20%, l'area:", o: ["Diminuisce del 4%", "Resta invariata", "Aumenta del 4%", "Diminuisce del 2%"], c: 0},
                {t: "5 macchinari producono 5 pezzi in 5 minuti. Quanti minuti impiegano 100 macchinari a produrre 100 pezzi?", o: ["5 minuti", "100 minuti", "20 minuti", "1 minuto"], c: 0},
                {t: "Se x : 6 = 15 : y, qual √® il valore di x*y?", o: ["90", "21", "2.5", "40"], c: 0},
                {t: "Un serbatoio perde il 10% del suo contenuto ogni ora. Se parte da 100 litri, quanto contiene dopo 2 ore?", o: ["81 litri", "80 litri", "90 litri", "85 litri"], c: 0},
                {t: "Risolvi per k: 2x + 3y = k, sapendo che passa per il punto (2, -1).", o: ["1", "5", "-1", "7"], c: 0},
                {t: "La media di 4 numeri √® 25. Se togliamo un numero, la media dei rimanenti diventa 20. Qual √® il numero tolto?", o: ["40", "30", "35", "25"], c: 0},
                {t: "Un cubo di lato L ha volume V. Se il lato diventa 3L, il nuovo volume √®:", o: ["27V", "9V", "3V", "6V"], c: 0}
            ],
            [ // SET 3: Comprensione (FIXED: Added 't' property to all questions)
                {
                    reading: "La teoria dell'agire comunicativo di Habermas distingue tra agire strumentale, orientato al successo e all'efficacia tecnica, e agire comunicativo, orientato all'intesa e alla comprensione reciproca. Mentre il primo tratta gli interlocutori come mezzi per raggiungere un fine, il secondo presuppone il riconoscimento dell'altro come soggetto razionale capace di argomentare. Nelle societ√† moderne, la colonizzazione del 'mondo della vita' da parte dei sistemi economici e burocratici minaccia di ridurre ogni interazione a pura strumentalit√†, erodendo le basi della solidariet√† sociale.",
                    t: "Secondo il brano, qual √® il rischio principale nelle societ√† moderne?", o: ["La prevalenza dell'agire strumentale su quello comunicativo", "L'incapacit√† tecnica dei sistemi burocratici", "L'eccessiva solidariet√† che blocca l'economia", "La mancanza di successo nelle azioni individuali"], c: 0
                },
                {
                    reading: "L'inflazione da costi si verifica quando aumentano i prezzi dei fattori produttivi, come materie prime o salari, indipendentemente dalla domanda aggregata. Questo porta a una contrazione dell'offerta aggregata: le imprese, per mantenere i margini di profitto, alzano i prezzi e riducono la produzione. Un esempio storico √® lo shock petrolifero degli anni '70. Al contrario, l'inflazione da domanda deriva da un eccesso di spesa rispetto alla capacit√† produttiva del sistema.",
                    t: "L'inflazione da costi √® caratterizzata da:", o: ["Aumento dei prezzi e riduzione della produzione", "Aumento della domanda aggregata", "Riduzione dei salari", "Eccesso di capacit√† produttiva"], c: 0
                },
                {
                    reading: "Gli studi sull'epigenetica dimostrano che l'ambiente pu√≤ influenzare l'espressione genica senza alterare la sequenza del DNA. Fattori come dieta, stress e inquinamento possono aggiungere marcatori chimici al DNA, attivando o disattivando determinati geni. Queste modifiche possono essere ereditabili, suggerendo che le esperienze di una generazione possono avere ripercussioni biologiche su quelle successive, sfidando la visione classica del determinismo genetico assoluto.",
                    t: "L'epigenetica suggerisce che:", o: ["L'ambiente modifica l'espressione dei geni, non la sequenza", "Il DNA cambia sequenza in base alla dieta", "I caratteri acquisiti non sono mai ereditabili", "Lo stress non ha impatto biologico"], c: 0
                },
                {
                    reading: "Il Barocco, nato a Roma nel XVII secolo, si contrappone al rigore rinascimentale attraverso l'uso della linea curva, della teatralit√† e della meraviglia. L'obiettivo dell'arte barocca non √® pi√π l'armonia statica, ma il coinvolgimento emotivo dello spettatore attraverso illusioni ottiche, prospettive ardite e un uso drammatico della luce. Bernini e Borromini incarnano due anime diverse di questo stile: il primo pi√π sontuoso e trionfale, il secondo pi√π inquieto e geometricamente complesso.",
                    t: "Quale elemento distingue il Barocco dal Rinascimento secondo il testo?", o: ["La ricerca del coinvolgimento emotivo e della dinamicit√†", "L'uso esclusivo di linee rette", "La ricerca di un'armonia statica e razionale", "L'assenza di prospettiva"], c: 0
                },
                {
                    reading: "Il principio di indeterminazione di Heisenberg stabilisce un limite fondamentale alla precisione con cui si possono misurare contemporaneamente coppie di propriet√† fisiche, come posizione e quantit√† di moto. Non √® un limite tecnologico, ma intrinseco alla natura ondulatoria della materia. Pi√π precisamente si conosce la posizione di una particella, meno precisamente se ne pu√≤ conoscere la velocit√†, e viceversa.",
                    t: "Il principio di Heisenberg afferma che:", o: ["Esiste un limite intrinseco alla misurazione simultanea di alcune grandezze", "La tecnologia attuale non √® abbastanza precisa", "√à impossibile misurare la posizione di una particella", "La velocit√† e la posizione sono sempre identiche"], c: 0
                },
                {
                    reading: "(Stesso brano su Habermas) Secondo Habermas, l'agire strumentale:",
                    t: "Secondo Habermas, l'agire strumentale:", o: ["Tratta gli interlocutori come mezzi per un fine", "Mira alla comprensione reciproca", "√à alla base della solidariet√† sociale", "Non √® orientato al successo"], c: 0
                },
                {
                    reading: "(Stesso brano su Epigenetica) Le modifiche epigenetiche:",
                    t: "Le modifiche epigenetiche:", o: ["Possono essere trasmesse alle generazioni successive", "Cancellano la sequenza del DNA", "Sono irreversibili", "Dipendono solo dalla genetica, non dall'ambiente"], c: 0
                },
                {
                    reading: "(Stesso brano su Inflazione) Durante uno shock petrolifero come quello degli anni '70, ci si aspetta:",
                    t: "Durante uno shock petrolifero come quello degli anni '70, ci si aspetta:", o: ["Inflazione da costi", "Inflazione da domanda", "Deflazione", "Aumento della produzione"], c: 0
                },
                {
                    reading: "(Stesso brano su Barocco) Borromini viene descritto come:",
                    t: "Borromini viene descritto come:", o: ["Inquieto e geometricamente complesso", "Sontuoso e trionfale", "Rigoroso e rinascimentale", "Statico"], c: 0
                },
                {
                    reading: "(Stesso brano su Heisenberg) Se misuro con estrema precisione la velocit√† di una particella:",
                    t: "Se misuro con estrema precisione la velocit√† di una particella:", o: ["Perdo precisione sulla sua posizione", "Aumento la precisione sulla sua posizione", "Il principio non si applica", "La particella si ferma"], c: 0
                }
            ],
            [ // SET 4 (Logica Insiemi)
                {t: "In un ufficio di 50 persone: 20 parlano Inglese, 15 Francese, 5 entrambe. Quanti non parlano n√© Inglese n√© Francese?", o: ["20", "10", "15", "25"], c: 0},
                {t: "Tutti gli A sono B. Nessun B √® C. Qualche D √® A. Dunque:", o: ["Nessun A √® C", "Qualche C √® A", "Tutti i D sono B", "Nessun D √® C"], c: 0},
                {t: "Se √® vero che 'Nessun filosofo √® ignorante', allora sicuramente:", o: ["Nessun ignorante √® filosofo", "Tutti gli ignoranti sono filosofi", "Qualche filosofo √® ignorante", "Tutti i filosofi sono saggi"], c: 0},
                {t: "In una libreria: i Gialli sono il doppio dei Fantasy. I Fantasy sono il triplo degli Horror. Se gli Horror sono 5, quanti libri in totale?", o: ["50", "45", "30", "60"], c: 0},
                {t: "Quale diagramma rappresenta: Animali, Cani, Gatti?", o: ["Un insieme grande contenente due insiemi disgiunti", "Tre insiemi intersecati", "Un insieme dentro l'altro dentro l'altro", "Tre insiemi separati"], c: 0},
                {t: "Se X ‚äÇ Y e Y ‚à© Z = ‚àÖ, allora:", o: ["X ‚à© Z = ‚àÖ", "X ‚à© Z = X", "X ‚à™ Z = Y", "Z ‚äÇ X"], c: 0},
                {t: "In un gruppo sportivo, il 70% gioca a Calcio, il 40% a Basket. Qual √® la percentuale minima di chi gioca a entrambi?", o: ["10%", "30%", "40%", "0%"], c: 0},
                {t: "Negazione di 'Tutti i giorni mangio frutta e verdura':", o: ["Almeno un giorno non mangio frutta oppure non mangio verdura", "Nessun giorno mangio frutta", "Tutti i giorni non mangio verdura", "Almeno un giorno mangio solo carne"], c: 0},
                {t: "Tutti i medici sono laureati. Alcuni laureati sono disoccupati. Dunque:", o: ["Non si pu√≤ concludere nulla sui medici", "Alcuni medici sono disoccupati", "Tutti i medici sono occupati", "Nessun disoccupato √® medico"], c: 0},
                {t: "A √® padre di B. B √® fratello di C. C √® padre di D. A √® per D:", o: ["Il nonno", "Lo zio", "Il bisnonno", "Il padre"], c: 0}
            ],
            [ // SET 5 (Serie)
                {t: "Completare la serie: 3, 7, 15, 31, ...", o: ["63", "60", "45", "62"], c: 0},
                {t: "Completare la serie: 100, 96, 88, 76, 60, ...", o: ["40", "44", "48", "36"], c: 0},
                {t: "Un treno di 200m entra in una galleria di 800m a 50 m/s. Quanto tempo impiega a uscire completamente?", o: ["20 secondi", "16 secondi", "25 secondi", "10 secondi"], c: 0},
                {t: "Ho tre scatole con etichette sbagliate: BB (2 bianche), NN (2 nere), Mista. Estraggo 1 pallina dalla scatola 'Mista'. √à Bianca. Cosa c'√® nella scatola 'Mista'?", o: ["2 Bianche", "2 Nere", "1 Bianca e 1 Nera", "Impossibile dirlo"], c: 0}, 
                {t: "Individuare l'intruso: Tavolo, Sedia, Armadio, Libro.", o: ["Libro", "Tavolo", "Sedia", "Armadio"], c: 0},
                {t: "Se GATTO = 5, CANE = 4, ELEFANTE = 8, allora LUPO = ?", o: ["4", "5", "6", "3"], c: 0},
                {t: "Un orologio va avanti di 5 minuti ogni ora. Se lo regolo a mezzanotte, che ora segner√† (realmente) quando l'orologio segna le 13:00?", o: ["Circa 12:00", "14:05", "11:55", "13:05"], c: 0},
                {t: "Anagramma di citt√† italiana: NOGAVE.", o: ["GENOVA", "VERONA", "NOVARA", "PADOVA"], c: 0},
                {t: "Quanti numeri di 2 cifre diverse posso formare con 1, 2, 3?", o: ["6", "9", "3", "5"], c: 0},
                {t: "In una gara superi l'ultimo. In che posizione sei?", o: ["Impossibile", "Penultimo", "Ultimo", "Primo"], c: 0}
            ],
            [ // SET 6
                {t: "Se A implica B, e B √® falso, allora:", o: ["A √® falso", "A √® vero", "Non si sa A", "A √® vero o falso"], c: 0},
                {t: "'√à impossibile che non sia vero che non ho mangiato'. Significa:", o: ["Non ho mangiato", "Ho mangiato", "Forse ho mangiato", "Non ho fame"], c: 0},
                {t: "Tutti i chirurghi sono precisi. Mario non √® preciso. Dunque:", o: ["Mario non √® un chirurgo", "Mario √® un chirurgo distratto", "Mario potrebbe essere chirurgo", "Tutti i precisi sono chirurghi"], c: 0},
                {t: "Solo se piove prendo l'auto. Prendo l'auto. Dunque:", o: ["Piove", "Non piove", "C'√® il sole", "Ho bucato"], c: 0},
                {t: "Chi dorme non piglia pesci. Luigi piglia pesci. Dunque:", o: ["Luigi non dorme", "Luigi dorme", "Luigi √® fortunato", "Non si pu√≤ dire"], c: 0},
                {t: "Nessun A √® B. Tutti i C sono B. Dunque:", o: ["Nessun C √® A", "Qualche C √® A", "Tutti gli A sono C", "Nessun A √® C (equivalente)"], c: 0},
                {t: "Se X √® maggiore di Y e Y √® maggiore di Z, allora:", o: ["X √® maggiore di Z", "X √® uguale a Z", "Z √® maggiore di X", "X √® minore di Z"], c: 0},
                {t: "Quale frase √® logicamente equivalente a 'Se studi, passi'?", o: ["Se non passi, non hai studiato", "Se non studi, non passi", "Se passi, hai studiato", "Se studi, non passi"], c: 0},
                {t: "O mangi la minestra o salti dalla finestra. Non salto dalla finestra. Dunque:", o: ["Mangio la minestra", "Salto dalla finestra", "Non mangio", "Dormo"], c: 0},
                {t: "Dario mente sempre. Dario dice 'Io sto mentendo'. √à un paradosso?", o: ["S√¨", "No, √® vero", "No, √® falso", "Dipende"], c: 0}
            ],
            [ // SET 7 (Geometria)
                {t: "Area di un quadrato con diagonale 10 cm.", o: ["50 cm¬≤", "100 cm¬≤", "25 cm¬≤", "75 cm¬≤"], c: 0},
                {t: "Un rettangolo ha perimetro 20 e lati interi. Area massima?", o: ["25", "24", "21", "16"], c: 0},
                {t: "Volume sfera raggio R vs Cilindro raggio R altezza 2R. Rapporto?", o: ["2/3", "3/4", "1/2", "1"], c: 0},
                {t: "Angoli interni di un pentagono regolare:", o: ["540¬∞", "360¬∞", "720¬∞", "180¬∞"], c: 0},
                {t: "Area corona circolare con R=5 e r=3.", o: ["16œÄ", "9œÄ", "25œÄ", "4œÄ"], c: 0},
                {t: "Ipotenusa triangolo rettangolo cateti 5 e 12.", o: ["13", "15", "17", "10"], c: 0},
                {t: "Se l'area di un cerchio quadruplica, il raggio:", o: ["Raddoppia", "Quadruplica", "Resta uguale", "Triplica"], c: 0},
                {t: "Quante diagonali ha un esagono?", o: ["9", "6", "12", "5"], c: 0},
                {t: "Due rette parallele hanno:", o: ["Lo stesso coefficiente angolare", "Coefficienti opposti", "Prodotto coeff. = -1", "Nessuna relazione"], c: 0},
                {t: "Punto medio tra (2, 4) e (6, 8).", o: ["(4, 6)", "(3, 5)", "(5, 7)", "(8, 12)"], c: 0}
            ],
            [ // SET 8 (Calcolo)
                {t: "0.003 * 0.02 =", o: ["0.00006", "0.0006", "0.006", "0.06"], c: 0},
                {t: "Radice quadrata di 0.09", o: ["0.3", "0.03", "0.0081", "0.9"], c: 0},
                {t: "3 alla quarta diviso 3 alla seconda.", o: ["9", "3", "27", "81"], c: 0},
                {t: "Il 15% di 200 √® uguale al 20% di X. X vale:", o: ["150", "100", "300", "120"], c: 0},
                {t: "Velocit√†: 60 km in 40 minuti. Km/h?", o: ["90 km/h", "80 km/h", "100 km/h", "60 km/h"], c: 0},
                {t: "MCD tra 12 e 18.", o: ["6", "3", "2", "12"], c: 0},
                {t: "mcm tra 4 e 6.", o: ["12", "24", "2", "10"], c: 0},
                {t: "1/2 + 1/3 + 1/6 =", o: ["1", "5/6", "2/3", "0"], c: 0},
                {t: "Se 5 operai fanno un muro in 6 giorni, 3 operai ci mettono:", o: ["10 giorni", "8 giorni", "12 giorni", "9 giorni"], c: 0},
                {t: "Sconto composto: 100‚Ç¨ scontato del 50% e poi ancora del 50%. Prezzo finale?", o: ["25‚Ç¨", "0‚Ç¨", "50‚Ç¨", "75‚Ç¨"], c: 0}
            ],
            [ // SET 9
                {t: "Mattia crede che il suo orologio sia preciso. Segna le 10:00 ma sono le 10:15. L'osservazione:", o: ["Va contro la convinzione", "Conferma", "Non influenza", "√à irrilevante"], c: 0},
                {t: "Area triangolo equilatero lato 6.", o: ["9‚àö3", "36", "18", "12‚àö3"], c: 0},
                {t: "Serie: A, C, F, J, ...", o: ["O", "N", "M", "P"], c: 0},
                {t: "Contrario di 'Laconico'", o: ["Prolisso", "Breve", "Conciso", "Taciturno"], c: 0},
                {t: "Se A ‚à™ B = A, allora:", o: ["B √® sottoinsieme di A", "A √® sottoinsieme di B", "A e B sono disgiunti", "A √® vuoto"], c: 0},
                {t: "20% di 50% di 1000.", o: ["100", "200", "50", "10"], c: 0},
                {t: "Chi scrisse i Promessi Sposi?", o: ["Manzoni", "Leopardi", "Dante", "Verga"], c: 0},
                {t: "Soluzione di x¬≤ - 9 = 0", o: ["+3 e -3", "Solo 3", "Solo -3", "9"], c: 0},
                {t: "Un anno bisestile ha:", o: ["366 giorni", "365 giorni", "364 giorni", "360 giorni"], c: 0},
                {t: "Negazione di 'Qualche A √® B'", o: ["Nessun A √® B", "Tutti gli A sono B", "Qualche A non √® B", "Tutti i B sono A"], c: 0}
            ],
            [ // SET 10
                {t: "Se il raggio raddoppia, l'area del cerchio:", o: ["Quadruplica", "Raddoppia", "Triplica", "Dimezza"], c: 0},
                {t: "Probabilit√† di fare 12 con due dadi.", o: ["1/36", "1/12", "1/6", "1/18"], c: 0},
                {t: "Mattia crede che la banca sia aperta. √à domenica ed √® chiusa. L'info:", o: ["Va contro la convinzione", "Conferma", "Non influenza", "√à falsa"], c: 0},
                {t: "Sinonimo di 'Effimero'", o: ["Passeggero", "Duraturo", "Solido", "Antico"], c: 0},
                {t: "2/3 di 60", o: ["40", "20", "30", "50"], c: 0},
                {t: "Diagonale quadrato lato 5.", o: ["5‚àö2", "5", "10", "25"], c: 0},
                {t: "Se non studio, vengo bocciato. Sono stato promosso. Dunque:", o: ["Ho studiato", "Non ho studiato", "Sono fortunato", "Il prof √® buono"], c: 0},
                {t: "Capitale d'Italia", o: ["Roma", "Milano", "Firenze", "Torino"], c: 0},
                {t: "15% di 200", o: ["30", "20", "15", "40"], c: 0},
                {t: "Prossimo numero: 2, 4, 8, 16...", o: ["32", "24", "30", "20"], c: 0}
            ]
        ];

        let currentSetIndex = 0;
        let activeQuestions = [];
        let userAnswers = []; // -1 = skipped, index = selected
        let currentQIdx = 0;
        let quizTimer = 900;
        let quizInterval = null;
        let selectedOption = null;

        // --- PREP LUISS: INIT MENU ---
        const setContainer = document.getElementById('sets-container');
        SET_NAMES.forEach((name, idx) => {
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.onclick = () => startLuissSet(idx);
            div.innerHTML = `
                <div class="menu-icon" style="background: var(--luiss-light); color: var(--luiss-blue); font-size:14px;">${idx+1}</div>
                <div class="menu-content">
                    <h3>${name}</h3>
                </div>
            `;
            setContainer.appendChild(div);
        });

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startLuissSet(idx) {
            isQuizActive = true;
            currentSetIndex = idx;
            
            activeQuestions = RAW_SETS[idx].map(q => {
                let mappedOptions = q.o.map((txt, i) => ({ text: txt, isCorrect: (i === q.c) }));
                shuffleArray(mappedOptions);
                return {
                    text: q.t,
                    reading: q.reading || null,
                    options: mappedOptions
                };
            });

            userAnswers = new Array(10).fill(null); 
            currentQIdx = 0;
            quizTimer = 900;
            selectedOption = null;
            
            goTo('view-luiss-quiz');
            updateTimerDisplay();
            renderLuissQuestion();
            
            if(quizInterval) clearInterval(quizInterval);
            quizInterval = setInterval(() => {
                quizTimer--;
                updateTimerDisplay();
                if(quizTimer <= 0) {
                    finishLuissTest(true);
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            let m = Math.floor(quizTimer / 60);
            let s = quizTimer % 60;
            document.getElementById('quiz-timer').innerText = `${m}:${s<10?'0':''}${s}`;
            if(quizTimer < 60) document.getElementById('quiz-timer').style.color = "var(--danger)";
            else document.getElementById('quiz-timer').style.color = "var(--luiss-blue)";
        }

        function renderLuissQuestion() {
            selectedOption = null;
            let q = activeQuestions[currentQIdx];
            
            // Gestione testo lettura
            const readingBox = document.getElementById('luiss-reading-text');
            if(q.reading) {
                readingBox.style.display = 'block';
                readingBox.innerText = q.reading;
            } else {
                readingBox.style.display = 'none';
            }

            document.getElementById('quiz-progress').innerText = `${currentQIdx + 1} / 10`;
            document.getElementById('luiss-q-text').innerText = q.text;
            
            // Render Opzioni
            let html = '';
            q.options.forEach((optObj, i) => {
                html += `<div class="quiz-opt-btn" id="opt-btn-${i}" onclick="selectLuissOpt(this, ${i})">
                    <div class="quiz-marker"></div>
                    <div>${optObj.text}</div>
                </div>`;
            });
            document.getElementById('luiss-options').innerHTML = html;

            // Ripristina selezione se gi√† risposta
            if(userAnswers[currentQIdx] !== null && userAnswers[currentQIdx] !== -1) {
                const prevSelIdx = userAnswers[currentQIdx];
                const btn = document.getElementById(`opt-btn-${prevSelIdx}`);
                if(btn) selectLuissOpt(btn, prevSelIdx);
            }

            // Visibilit√† pulsante Indietro
            document.getElementById('btn-prev').style.visibility = (currentQIdx === 0) ? 'hidden' : 'visible';
        }

        function selectLuissOpt(el, idx) {
            document.querySelectorAll('.quiz-opt-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.quiz-marker').forEach(m => m.style.backgroundColor = '#fff');
            
            el.classList.add('selected');
            el.querySelector('.quiz-marker').style.backgroundColor = 'var(--luiss-blue)';
            selectedOption = idx;
        }

        function prevQuestion() {
            if(currentQIdx > 0) {
                currentQIdx--;
                renderLuissQuestion();
            }
        }

        function skipLuissQuestion() {
            userAnswers[currentQIdx] = -1;
            nextQuestion();
        }

        function submitLuissAnswer() {
            if(selectedOption !== null) {
                userAnswers[currentQIdx] = selectedOption;
            } else if (userAnswers[currentQIdx] === null) {
                return; // Richiede selezione
            }
            nextQuestion();
        }

        function nextQuestion() {
            currentQIdx++;
            if(currentQIdx < 10) {
                renderLuissQuestion();
            } else {
                finishLuissTest(false);
            }
        }

        function abortQuiz() {
            if(confirm("Sei sicuro di voler annullare il set? Perderai i progressi.")) {
                isQuizActive = false;
                clearInterval(quizInterval);
                goTo('view-luiss-menu');
            }
        }

        function finishLuissTest(timeout) {
            isQuizActive = false;
            clearInterval(quizInterval);
            goTo('view-luiss-result');
            
            let correct = 0;
            let wrong = 0;
            let skipped = 0;
            
            userAnswers.forEach((userSelIndex, qIdx) => {
                if (userSelIndex === -1 || userSelIndex === null) {
                    skipped++;
                } else {
                    if (activeQuestions[qIdx].options[userSelIndex].isCorrect) {
                        correct++;
                    } else {
                        wrong++;
                    }
                }
            });

            document.getElementById('final-score-title').innerText = `${correct}/10`;
            document.getElementById('stat-correct').innerText = correct;
            document.getElementById('stat-wrong').innerText = wrong;
            document.getElementById('stat-skipped').innerText = skipped;
            
            let msg = document.getElementById('final-score-msg');
            if(timeout) msg.innerText = "Tempo scaduto.";
            else if(correct >= 9) msg.innerHTML = "Eccellente. Preparazione solida.";
            else if(correct >= 7) msg.innerHTML = "Buon risultato. Sopra la media.";
            else if(correct >= 5) msg.innerHTML = "Discreto. Margine di miglioramento.";
            else msg.innerHTML = "Punteggio insufficiente. Necessario ripasso.";
        }

        function showReview() {
            goTo('view-luiss-review');
            const container = document.getElementById('review-container');
            container.innerHTML = '';
            
            activeQuestions.forEach((q, qIdx) => {
                const userSelIndex = userAnswers[qIdx];
                const isSkipped = (userSelIndex === -1 || userSelIndex === null);
                
                let isAnswerCorrect = false;
                if (!isSkipped && q.options[userSelIndex].isCorrect) isAnswerCorrect = true;

                let statusClass = isSkipped ? 'status-skipped' : (isAnswerCorrect ? 'status-correct' : 'status-wrong');
                
                let optsHtml = '';
                q.options.forEach((optObj, optIdx) => {
                    let className = 'review-opt';
                    if (optObj.isCorrect) className += ' is-correct';
                    if (!isSkipped && optIdx === userSelIndex && !optObj.isCorrect) className += ' is-wrong';
                    
                    optsHtml += `<div class="${className}">${optObj.text}</div>`;
                });
                
                let readingRef = q.reading ? `<div style="font-size:12px; color:var(--text-sec); margin-bottom:8px; font-style:italic;">Basato sul brano letto precedentemente.</div>` : '';

                const itemDiv = document.createElement('div');
                itemDiv.className = `review-item ${statusClass}`;
                itemDiv.innerHTML = `
                    <div class="review-q">${q.text}</div>
                    ${readingRef}
                    ${optsHtml}
                `;
                container.appendChild(itemDiv);
            });
        }

    </script>
</body>
</html>
